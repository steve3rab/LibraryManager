name: Java CI with Maven

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-test-libraryManager:
    runs-on: ubuntu-latest

    steps:
      - name: Step 1 - Checkout code
        uses: actions/checkout@v3

      - name: Step 2 - Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Step 3 - Run unit tests
        working-directory: .
        run: |
          echo "Loading... Running unit tests for libraryManager"
          mvn clean verify -Dtest=*IT
          
      - name: Step 4 - Get Surefire Reports Path
        id: surefire-reports
        run: |
          surefire_reports_path=$(find . -type d -name 'surefire-reports')
          echo "SUREFIRE_REPORTS_PATH=$surefire_reports_path" >> $GITHUB_ENV
          echo "::set-output name=surefire-reports-path::$surefire_reports_path"
          echo "SUREFIRE_REPORTS_PATH=$surefire_reports_path" >> $GITHUB_STATE/surefire-reports-path.env

      - name: Step 5 - Upload test results
        uses: actions/upload-artifact@v3
        with:
          name: test-results-libraryManager
          path: ${{ steps.surefire-reports.outputs.surefire-reports-path }}
          
      - name: Step 6 - Get JaCoCo Report Path
        id: jacoco-report
        run: |
          jacoco_report_path=$(find . -type f -name 'index.html' | grep 'target/site/jacoco/index.html')
          echo "JACOCO_REPORT_PATH=$jacoco_report_path" >> $GITHUB_ENV
          echo "::set-output name=jacoco-report-path::$jacoco_report_path"
          echo "JACOCO_REPORT_PATH=$jacoco_report_path" >> $GITHUB_STATE/jacoco-report-path.env

      - name: Step 7 - Upload code coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: jacoco-report-libraryManager
          path: ${{ steps.jacoco-report.outputs.jacoco-report-path }}
